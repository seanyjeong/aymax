<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>급여명세서</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { text-align: center; }
        .payroll-container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .input-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-container label { flex: 1; text-align: left; }
        .input-container input, .input-container select { flex: 2; padding: 5px; }
        .payroll-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .payroll-table th, .payroll-table td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .signature { margin-top: 20px; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>안양 맥스체대입시 급여명세서</h1>

    <div class="input-container">
        <label>급여 방식:</label>
        <select id="salaryType">
            <option value="hourly">시급</option>
            <option value="daily">일급</option>
            <option value="monthly">월급</option>
        </select>
    </div>

    <div class="input-container">
        <label for="hourlyRate">시급 (₩):</label>
        <input type="number" id="hourlyRate" placeholder="예: 25000">
    </div>

    <div class="input-container">
        <label for="dailyRate">일급 (₩):</label>
        <input type="number" id="dailyRate" placeholder="예: 100000">
    </div>

    <div class="input-container">
        <label for="monthlySalary">월급 (₩):</label>
        <input type="number" id="monthlySalary" placeholder="예: 3000000">
    </div>

    <div class="input-container">
        <label>세금 적용 (3.3%)</label>
        <input type="checkbox" id="applyTax">
    </div>

    <div class="payroll-container" id="payroll-section">
        <h2 id="payroll-title">#강사이름 #월 급여명세서</h2>

        <div class="input-container">
            <label for="teacher">강사 이름:</label>
            <select id="teacher" onchange="updateTitle();"></select>
        </div>

        <div class="input-container">
            <label for="month">월 선택:</label>
            <input type="month" id="month" onchange="updateTitle()">
        </div>

        <table class="payroll-table">
            <tr>
                <th>출근일수</th>
                <th>총 근무시간</th>
                <th>총 급여</th>
                <th>세금 (3.3%)</th>
                <th>실수령액</th>
            </tr>
            <tr>
                <td id="attendanceDays">0</td>
                <td id="totalHours">0시간</td>
                <td id="totalSalary">₩0</td>
                <td id="taxAmount">₩0</td>
                <td id="netSalary">₩0</td>
            </tr>
        </table>

        <h3>출근 상세 기록</h3>
        <table class="payroll-table">
            <thead>
                <tr>
                    <th>날짜</th>
                    <th>요일</th>
                    <th>근무시간</th>
                </tr>
            </thead>
            <tbody id="attendanceTable">
                <tr><td colspan="3">출근 기록 없음</td></tr>
            </tbody>
        </table>

        <div class="signature">맥스체대입시 안양교육원장</div>
    </div>

    <button onclick="calculateSalary()">급여 계산</button>
    <button onclick="downloadPDF()">PDF 저장</button>
    <button onclick="confirmSalary()">급여 확정</button>
    
    <script>
    async function loadTeachers() {
        const response = await fetch('https://supermax.kr/anteachers');
        const teachers = await response.json();
        const teacherSelect = document.getElementById('teacher');

        // ✅ 오류 해결: 강사 목록이 로드되면 기본 선택값 설정
        teacherSelect.innerHTML = teachers.map(teacher => 
            `<option value="${teacher.id}">${teacher.이름} (${teacher.직급 || '강사'})</option>`
        ).join('');

        updateTitle(); // ✅ 강사 목록이 로드된 후 제목 업데이트 실행
    }

   async function updateTitle() {
        const teacherSelect = document.getElementById('teacher');

        // ✅ 오류 해결: 강사 선택 목록이 없는 경우 실행하지 않음
        if (!teacherSelect || teacherSelect.selectedIndex === -1) return;

        const teacherName = teacherSelect.selectedOptions[0].text.split(" ")[0];
        const monthValue = document.getElementById('month').value.split("-")[1] || "월";
        document.getElementById('payroll-title').textContent = `#${teacherName} #${monthValue}월 급여명세서`;
    }


     async function calculateSalary() {
            const teacherId = document.getElementById('teacher').value;
            const monthValue = document.getElementById('month').value;
            const salaryType = document.getElementById('salaryType').value;
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const dailyRate = parseFloat(document.getElementById('dailyRate').value) || 0;
            const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
            const applyTax = document.getElementById('applyTax').checked;

            if (!teacherId || !monthValue) {
                alert('강사 및 월을 선택해주세요.');
                return;
            }

            const [year, month] = monthValue.split('-');
            const response = await fetch(`https://supermax.kr/anattendancehistory_monthly?year=${year}&month=${month}`);
            const attendanceRecords = await response.json();

            let totalHours = 0;
            let attendanceDays = 0;

            const tableBody = document.getElementById('attendanceTable');
            tableBody.innerHTML = "";

            attendanceRecords.forEach(record => {
                if (record.강사_id == teacherId && (record.출근 === 1 || record.지각 === 1)) {
                    attendanceDays++;
                    totalHours += record.근무시간 || 0;

                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${record.출근일}</td><td>${['일', '월', '화', '수', '목', '금', '토'][new Date(record.출근일).getDay()]}</td><td>${record.근무시간 || 0}시간</td>`;
                    tableBody.appendChild(row);
                }
            });

            let totalSalary = salaryType === "hourly" ? totalHours * hourlyRate :
                              salaryType === "daily" ? attendanceDays * dailyRate :
                              monthlySalary;

            let taxAmount = applyTax ? totalSalary * 0.033 : 0;
            let netSalary = totalSalary - taxAmount;

            document.getElementById('attendanceDays').textContent = attendanceDays;
            document.getElementById('totalHours').textContent = `${totalHours}시간`;
            document.getElementById('totalSalary').textContent = `₩${totalSalary.toLocaleString()}`;
            document.getElementById('taxAmount').textContent = `₩${taxAmount.toLocaleString()}`;
            document.getElementById('netSalary').textContent = `₩${netSalary.toLocaleString()}`;
        }

            // 총 출근일수 업데이트
            document.getElementById('totalAttendanceDisplay').textContent = "총 출근일수: " + attendanceDays.length + "일";

            // HTML 테이블에 출근 날짜 추가
            const tableBody = document.getElementById('attendanceDatesTable');
            tableBody.innerHTML = "";

            if (attendanceDays.length > 0) {
                attendanceDays.forEach(day => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${day.date}</td><td>${day.day}</td>`;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="2">출근 기록 없음</td></tr>`;
            }
        

        async function confirmSalary() {
            const teacherId = document.getElementById('teacher').value;
            const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];
            const monthValue = document.getElementById('month').value;
            const netSalary = parseFloat(document.getElementById('netSalary').textContent.replace(/₩|,/g, ''));

            if (!teacherId || !monthValue || isNaN(netSalary)) {
                alert("급여 계산 후 확정할 수 있습니다.");
                return;
            }

            const [year, month] = monthValue.split('-');

            const salaryData = {
                year: parseInt(year),
                month: parseInt(month),
                teacherId: teacherId,
                teacherName: teacherName,
                salaryAmount: netSalary
            };

            const response = await fetch('https://supermax.kr/anconfirmSalary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(salaryData)
            });

            if (response.ok) {
                alert("급여가 확정되었습니다!");
            } else {
                alert("급여 확정 중 오류 발생!");
            }
        }

        async function downloadPDF() {
            const payrollSection = document.getElementById('payroll-section');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // 선택된 강사 이름 가져오기
            const teacherName = document.getElementById('teacher').selectedOptions[0].text.split(" ")[0];

            // 선택된 년월 가져오기 (YYYYMM 형식)
            const monthValue = document.getElementById('month').value;
            if (!monthValue || !teacherName) {
                alert("강사와 월을 선택해주세요!");
                return;
            }
            const [year, month] = monthValue.split('-');
            const fileName = `${year}${month}_${teacherName}.pdf`;

            html2canvas(payrollSection).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 10, 10, 180, 0);
                pdf.save(fileName);
            });
        }

        loadTeachers();
    </script>
    <footer style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
        &copy; 2025 안양맥스 강사 출근부 시스템 BY 정원장
    </footer>
</body>
</html>
