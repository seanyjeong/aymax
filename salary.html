<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ ë‚´ì—­ ì¡°íšŒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        async function fetchSalaryData() {
            const monthValue = document.getElementById('monthSelect').value;
            if (!monthValue) {
                alert("ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const [year, month] = monthValue.split('-');
            const response = await fetch(`https://supermax.kr/angetSalaryList?year=${year}&month=${month}`);
            const data = await response.json();

            const tableBody = document.getElementById('salaryTableBody');
            tableBody.innerHTML = "";

            let totalSalary = 0;
            let totalTax = 0;
            let totalNetSalary = 0;

            if (data.length > 0) {
                data.forEach(record => {
                    totalSalary += record.ì´ê¸‰ì—¬;
                    totalTax += record.ì„¸ê¸ˆê¸ˆì•¡;
                    totalNetSalary += record.ì‹¤ì§€ê¸‰ì•¡;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.ê°•ì‚¬ì´ë¦„}</td>
                        <td>â‚©${record.ì´ê¸‰ì—¬.toLocaleString()}</td>
                        <td>â‚©${record.ì„¸ê¸ˆê¸ˆì•¡.toLocaleString()}</td>
                        <td>â‚©${record.ì‹¤ì§€ê¸‰ì•¡.toLocaleString()}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="4">í™•ì •ëœ ê¸‰ì—¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            }

            document.getElementById('totalSalary').textContent = `ì´ ì§€ê¸‰ ê¸ˆì•¡: â‚©${totalSalary.toLocaleString()}`;
            document.getElementById('totalTax').textContent = `ì´ ì„¸ê¸ˆ: â‚©${totalTax.toLocaleString()}`;
            document.getElementById('totalNetSalary').textContent = `ì´ ì‹¤ì§€ê¸‰ì•¡: â‚©${totalNetSalary.toLocaleString()}`;
        }

     
async function downloadExcel() {
    try {
        const year = new Date().getFullYear();
        const months = Array.from({ length: 12 }, (_, i) => String(i + 1).padStart(2, '0'));

        // âœ… ì „ì²´ ê°•ì‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const teachersResponse = await fetch("https://supermax.kr/anteachers");
        const teachers = await teachersResponse.json();
        console.log("ğŸ“¢ ê°•ì‚¬ ëª©ë¡:", teachers);

        // âœ… ê°•ì‚¬ ì´ë¦„ â†’ ê°•ì‚¬ ID ë§¤í•‘
        const teacherMap = {};
        teachers.forEach(teacher => {
            teacherMap[teacher.ì´ë¦„] = teacher.id;
        });

        console.log("ğŸ“Œ ê°•ì‚¬ ì´ë¦„ â†’ ID ë§¤í•‘:", teacherMap);

        // âœ… ëª¨ë“  ì›”ì˜ ê¸‰ì—¬ ë‚´ì—­ ì €ì¥
        let salaryData = {};
        let monthlyTotals = {};

        // âœ… ì´ˆê¸°í™”
        months.forEach(month => {
            monthlyTotals[`${year}-${month}`] = { ì´ê¸‰ì—¬: 0, ì„¸ê¸ˆê¸ˆì•¡: 0, ì‹¤ì§€ê¸‰ì•¡: 0 };
        });

        // âœ… ê° ì›”ë³„ ê¸‰ì—¬ ë°ì´í„° ìˆ˜ì§‘
        for (let month of months) {
            const response = await fetch(`https://supermax.kr/angetSalaryList?year=${year}&month=${month}`);
            const data = await response.json();
            console.log(`ğŸ“¢ ${year}-${month} ê¸‰ì—¬ ë°ì´í„°:`, data);

            data.forEach(record => {
                const teacherId = teacherMap[record.ê°•ì‚¬ì´ë¦„]; // ê°•ì‚¬ì´ë¦„ìœ¼ë¡œ ID ì°¾ê¸°
                if (!teacherId) {
                    console.warn(`âš ï¸ ê°•ì‚¬ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${record.ê°•ì‚¬ì´ë¦„}`);
                    return;
                }

                if (!salaryData[teacherId]) {
                    salaryData[teacherId] = {};
                }

                salaryData[teacherId][`${year}-${month}`] = {
                    ì´ê¸‰ì—¬: record.ì´ê¸‰ì—¬,
                    ì„¸ê¸ˆê¸ˆì•¡: record.ì„¸ê¸ˆê¸ˆì•¡,
                    ì‹¤ì§€ê¸‰ì•¡: record.ì‹¤ì§€ê¸‰ì•¡
                };

                // âœ… ì›”ë³„ í•©ê³„ ëˆ„ì 
                monthlyTotals[`${year}-${month}`].ì´ê¸‰ì—¬ += record.ì´ê¸‰ì—¬;
                monthlyTotals[`${year}-${month}`].ì„¸ê¸ˆê¸ˆì•¡ += record.ì„¸ê¸ˆê¸ˆì•¡;
                monthlyTotals[`${year}-${month}`].ì‹¤ì§€ê¸‰ì•¡ += record.ì‹¤ì§€ê¸‰ì•¡;
            });
        }

        // âœ… ê°•ì‚¬ë³„ ì›”ë³„ ê¸‰ì—¬ ë‚´ì—­ í™•ì¸
        console.log("ğŸ“Œ ìˆ˜ì§‘ëœ ê¸‰ì—¬ ë°ì´í„° (salaryData):", salaryData);
        console.log("ğŸ“Œ ì›”ë³„ ì´ì•¡ (monthlyTotals):", monthlyTotals);

        // âœ… ì—‘ì…€ ë°ì´í„° ë°°ì—´ ìƒì„± (í—¤ë” í¬í•¨)
        const sheetData = [
            ["ê°•ì‚¬ì´ë¦„", "ì£¼ë¯¼ë²ˆí˜¸", "ì€í–‰ëª…", "ê³„ì¢Œë²ˆí˜¸", ...months.flatMap(m => [`${year}-${m} (ì´ê¸‰ì—¬)`, `${year}-${m} (ì„¸ê¸ˆ)`, `${year}-${m} (ì‹¤ì§€ê¸‰ì•¡)`]), "ê°•ì‚¬ë³„ ì´ì•¡"]
        ];

        let totalAnnualSalary = { ì´ê¸‰ì—¬: 0, ì„¸ê¸ˆê¸ˆì•¡: 0, ì‹¤ì§€ê¸‰ì•¡: 0 };

        // âœ… ê° ê°•ì‚¬ì˜ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì—¬ í–‰ ì¶”ê°€
        teachers.forEach(teacher => {
            const row = [
                teacher.ì´ë¦„,
                teacher.ì£¼ë¯¼ë²ˆí˜¸ || "",
                teacher.ì€í–‰ëª… || "",
                teacher.ê³„ì¢Œë²ˆí˜¸ || ""
            ];

            let teacherTotal = { ì´ê¸‰ì—¬: 0, ì„¸ê¸ˆê¸ˆì•¡: 0, ì‹¤ì§€ê¸‰ì•¡: 0 };

            months.forEach(month => {
                const monthKey = `${year}-${month}`;
                const data = salaryData[teacher.id]?.[monthKey] || { ì´ê¸‰ì—¬: 0, ì„¸ê¸ˆê¸ˆì•¡: 0, ì‹¤ì§€ê¸‰ì•¡: 0 };

                row.push(data.ì´ê¸‰ì—¬, data.ì„¸ê¸ˆê¸ˆì•¡, data.ì‹¤ì§€ê¸‰ì•¡);

                teacherTotal.ì´ê¸‰ì—¬ += data.ì´ê¸‰ì—¬;
                teacherTotal.ì„¸ê¸ˆê¸ˆì•¡ += data.ì„¸ê¸ˆê¸ˆì•¡;
                teacherTotal.ì‹¤ì§€ê¸‰ì•¡ += data.ì‹¤ì§€ê¸‰ì•¡;
            });

            row.push(teacherTotal.ì´ê¸‰ì—¬, teacherTotal.ì„¸ê¸ˆê¸ˆì•¡, teacherTotal.ì‹¤ì§€ê¸‰ì•¡);
            totalAnnualSalary.ì´ê¸‰ì—¬ += teacherTotal.ì´ê¸‰ì—¬;
            totalAnnualSalary.ì„¸ê¸ˆê¸ˆì•¡ += teacherTotal.ì„¸ê¸ˆê¸ˆì•¡;
            totalAnnualSalary.ì‹¤ì§€ê¸‰ì•¡ += teacherTotal.ì‹¤ì§€ê¸‰ì•¡;
            sheetData.push(row);
        });

        // âœ… ë§ˆì§€ë§‰ í–‰: ì›”ë³„ ì´ì•¡
        sheetData.push([
            "ì›”ë³„ ì´ì•¡", "", "", "",
            ...months.flatMap(m => [monthlyTotals[`${year}-${m}`].ì´ê¸‰ì—¬, monthlyTotals[`${year}-${m}`].ì„¸ê¸ˆê¸ˆì•¡, monthlyTotals[`${year}-${m}`].ì‹¤ì§€ê¸‰ì•¡]),
            totalAnnualSalary.ì´ê¸‰ì—¬, totalAnnualSalary.ì„¸ê¸ˆê¸ˆì•¡, totalAnnualSalary.ì‹¤ì§€ê¸‰ì•¡
        ]);

        console.log("ğŸ“¢ ìµœì¢… ì—‘ì…€ ë°ì´í„° (sheetData):", sheetData);

        // âœ… ì—‘ì…€ íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(sheetData);

        // âœ… ìˆ«ì ì…€ í˜•ì‹ ì§€ì • (ì²œ ë‹¨ìœ„ êµ¬ë¶„ê¸°í˜¸ ì¶”ê°€)
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = 1; R <= range.e.r; R++) {
            for (let C = 4; C <= range.e.c; C++) {
                const cell = ws[XLSX.utils.encode_cell({r: R, c: C})];
                if (cell && typeof cell.v === 'number') {
                    cell.z = '#,##0';
                }
            }
        }

        XLSX.utils.book_append_sheet(wb, ws, "ê¸‰ì—¬ë‚´ì—­");
        XLSX.writeFile(wb, `ê¸‰ì—¬ë‚´ì—­_${year}.xlsx`);

    } catch (error) {
        console.error("âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

    </script>
</head>
<body>

   <h1>ê¸‰ì—¬ ë‚´ì—­ ì¡°íšŒ</h1>

    <label for="monthSelect">ì›” ì„ íƒ:</label>
    <input type="month" id="monthSelect">
    <button onclick="fetchSalaryData()">ì¡°íšŒ</button>
    <button onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

    <h2>ê¸‰ì—¬ í™•ì •ëœ ê°•ì‚¬ ëª©ë¡</h2>
    <table>
        <thead>
            <tr>
                <th>ê°•ì‚¬ ì´ë¦„</th>
                <th>ì´ê¸‰ì—¬</th>
                <th>ì„¸ê¸ˆ (3.3%)</th>
                <th>ì‹¤ì§€ê¸‰ì•¡</th>
            </tr>
        </thead>
        <tbody id="salaryTableBody">
            <tr><td colspan="4">ì¡°íšŒëœ ê¸‰ì—¬ ë°ì´í„° ì—†ìŒ</td></tr>
        </tbody>
    </table>

    <h3 id="totalSalary">ì´ ì§€ê¸‰ ê¸ˆì•¡: â‚©0</h3>
    <h3 id="totalTax">ì´ ì„¸ê¸ˆ: â‚©0</h3>
    <h3 id="totalNetSalary">ì´ ì‹¤ì§€ê¸‰ì•¡: â‚©0</h3>

    <footer style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
        &copy; 2025 ì•ˆì–‘ë§¥ìŠ¤ ê°•ì‚¬ ì¶œê·¼ë¶€ ì‹œìŠ¤í…œ BY ì •ì›ì¥
    </footer>
</body>
</html>
